// Copyright (c) Microsoft Corporation.
// Licensed under the MIT license.
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.SampleHandler = void 0;
const tslib_1 = require("tslib");
const path = tslib_1.__importStar(require("path"));
const fs = tslib_1.__importStar(require("fs-extra"));
const constants_1 = require("./constants");
const folder_1 = require("../../../folder");
const result_1 = require("./result");
const common_1 = require("../../../common");
const constants_2 = require("../../../common/constants");
const errors_1 = require("./errors");
class SampleHandler {
    constructor(projectPath, languageType, component) {
        this.projectRoot = projectPath;
        this.languageExt = languageType === constants_1.LanguageType.JS ? constants_1.FileType.JS : constants_1.FileType.TS;
        this.component = component;
    }
    async generateSampleCode(config) {
        const fileSuffix = this.languageExt;
        const baseDirectory = path.join(folder_1.getTemplatesFolder(), "plugins", "resource", "apiconnector", "sample");
        const templateDirectory = path.join(baseDirectory, fileSuffix);
        const headerCommentTemplateFilePath = path.join(baseDirectory, constants_1.Constants.headerCommentTemplate);
        const footerCommentTemplateFilePath = path.join(baseDirectory, constants_1.Constants.footerCommentTemplate);
        const templateName = config.AuthConfig.AuthType + constants_1.Constants.templateEx;
        const templateFilePath = path.join(templateDirectory, templateName);
        try {
            const footerCommentString = await fs.readFile(footerCommentTemplateFilePath, constants_2.ConstantString.UTF8Encoding);
            const headerCommentString = await fs.readFile(headerCommentTemplateFilePath, constants_2.ConstantString.UTF8Encoding);
            let templateString = await fs.readFile(templateFilePath, constants_2.ConstantString.UTF8Encoding);
            templateString = `${headerCommentString}\n${templateString}\n${footerCommentString}`;
            const context = {
                config: config,
                capitalName: config.APIName.toUpperCase(),
                component: this.component,
                languageExt: this.languageExt,
            };
            const codeFileName = config.APIName + "." + fileSuffix;
            let codePath = path.join(this.projectRoot, this.component);
            if (await fs.pathExists(path.join(codePath, "src"))) {
                codePath = path.join(codePath, "src");
            }
            codePath = path.join(codePath, constants_1.Constants.sampleCodeDir);
            fs.ensureDir(codePath);
            const codeFilePath = path.join(codePath, codeFileName);
            if (await fs.pathExists(codeFilePath)) {
                await fs.remove(codeFilePath);
            }
            const codeFile = common_1.compileHandlebarsTemplateString(templateString, context);
            await fs.writeFile(codeFilePath, codeFile);
            return {
                changeType: result_1.FileChangeType.Create,
                filePath: codeFilePath,
            };
        }
        catch (error) {
            throw result_1.ResultFactory.SystemError(errors_1.ErrorMessage.SampleCodeCreateFailError.name, errors_1.ErrorMessage.SampleCodeCreateFailError.message(templateFilePath, error.message));
        }
    }
}
exports.SampleHandler = SampleHandler;
//# sourceMappingURL=sampleHandler.js.map